# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

from langbot_plugin.api.entities.builtin.platform import message as platform_message
from langbot_plugin.api.definition.components.common.event_listener import EventListener
from langbot_plugin.api.entities import events, context

import re
import base64
import markdown
from html2image import Html2Image
import os
from PIL import Image
import tempfile
from io import BytesIO
import math
import asyncio
from concurrent.futures import ThreadPoolExecutor, TimeoutError as FutureTimeoutError

#pymdown-extensionsÊñπÂºèÊµãËØï
try:
    import pymdownx.emoji
    import pymdownx.superfences
    import pymdownx.highlight
    import pymdownx.inlinehilite
    import pymdownx.snippets
    import pymdownx.tabbed
    import pymdownx.tasklist
    import pymdownx.tilde
    import pymdownx.caret
    import pymdownx.mark
    import pymdownx.smartsymbols
    import pymdownx.arithmatex
    import pymdownx.betterem
    import pymdownx.critic
    import pymdownx.details
    import pymdownx.escapeall
    import pymdownx.extra
    import pymdownx.keys
    import pymdownx.progressbar
    import pymdownx.saneheaders
    PYMDEXT_AVAILABLE = True
except ImportError:
    PYMDEXT_AVAILABLE = False
    print("Ë≠¶Âëä: pymdown-extensions Êú™ÂÆâË£ÖÔºåÂ∞Ü‰ΩøÁî®Ê†áÂáÜ Markdown Êâ©Â±ï")
    print("Ë≠¶Âëä: pymdown-extensions Âª∫ËÆÆÂÆâË£ÖÔºå‰ºòÂÖà‰ΩøÁî®")

response_text = None #ÂÖ®Â±ÄÂèòÈáèÔºåÂØºÂÖ•Ê∂àÊÅØ

#Ëé∑ÂèñÈÖçÁΩÆ
get_url = False
get_markdown = 2
side_of_markdown = 800
max_length = 50000
#Ë∞ÉËØïËæìÂá∫
test_mode = True
#ÈòªÊ≠¢ÂõûÂ§ç
breakout = True
#ÊòØÂê¶ËæìÂá∫ÂõæÁâá
out_photo = False

class config:
    def __init__(self):
        super().__init__()
        
    async def initialize(self):
        await super().initialize()

        #Ëé∑ÂèñÈªòËÆ§ÈÖçÁΩÆ
        config = self.plugin.get_config()
        #ÊãÜÂàÜÈÖçÁΩÆ
        global get_url
        global get_markdown
        global side_of_markdown
        global test_mode
        global breakout
        global out_photo
        global max_length
        max_length = config.get("length_of_markdown", 50000)
        out_photo = config.get("out_photo", False)
        breakout = config.get("breakout", True)
        get_url = config.get("get_url", False)
        get_markdown = config.get("get_markdown", 2)
        side_of_markdown = config.get("side_of_markdown", 800)
        test_mode = config.get("test_mode", True)
        if test_mode:
            print("ÊµãËØïÊ®°ÂºèÂ∑≤ÂºÄÂêØ")
            print(f"get_url: {get_url}")
            print(f"get_markdown: {get_markdown}")
            print(f"side_of_markdown: {side_of_markdown}")
            print(f"test_mode: {test_mode}")
            print(f"breakout: {breakout}")
            print(f"out_photo: {out_photo}")
        return 0

class MarkdownToBase64Converter:
    def __init__(self):
        self.hti = None
        self.executor = ThreadPoolExecutor(max_workers=2)
        self._initialized = False
        
    def _ensure_initialized(self):
        """Âª∂ËøüÂàùÂßãÂåñ Html2Image ÂØπË±°"""
        if not self._initialized:
            self.hti = Html2Image()
            self.hti.browser_flags = ['--hide-scrollbars', '--disable-gpu', '--no-sandbox']
            self._initialized = True
    
    def convert(self, markdown_text: str, timeout: int = 30) -> str:
        """Â∞Ü Markdown ÊñáÊú¨ËΩ¨Êç¢‰∏∫ Base64 ÂõæÁâáÔºåÊîØÊåÅÂÆåÊï¥ËØ≠Ê≥ïÂíåÈ´òÂ∫¶Ëá™ÈÄÇÂ∫î
        
        Args:
            markdown_text: Markdown ÊñáÊú¨ÂÜÖÂÆπ
            timeout: Ë∂ÖÊó∂Êó∂Èó¥ÔºàÁßíÔºâÔºåÈªòËÆ§30Áßí
            
        Returns:
            Base64 ÁºñÁ†ÅÁöÑÂõæÁâáÂ≠óÁ¨¶‰∏≤
        """
        try:
            self._ensure_initialized()
            
            # ‰ΩøÁî®Á∫øÁ®ãÊ±†ÊâßË°åËΩ¨Êç¢ÔºåÈÅøÂÖçÈòªÂ°û‰∏ªÁ∫øÁ®ã
            future = self.executor.submit(self._convert_sync, markdown_text)
            
            try:
                result = future.result(timeout=timeout)
                return result
            except FutureTimeoutError:
                future.cancel()
                print(f"ËΩ¨Êç¢Ë∂ÖÊó∂Ôºà{timeout}ÁßíÔºâÔºåÂèñÊ∂àÊìç‰Ωú")
                return ""
                
        except Exception as e:
            print(f"ËΩ¨Êç¢ÈîôËØØ: {e}")
            import traceback
            traceback.print_exc()
            return ""
    
    def _convert_sync(self, markdown_text: str) -> str:
        """ÂêåÊ≠•ËΩ¨Êç¢ÊñπÊ≥ïÔºåÂú®Á∫øÁ®ãÊ±†‰∏≠ÊâßË°å"""
        try:
            # ËæìÂÖ•È™åËØÅ
            if not markdown_text or not isinstance(markdown_text, str):
                print("‚ö†Ô∏è Êó†ÊïàÁöÑËæìÂÖ•Ôºömarkdown_text ÂøÖÈ°ªÊòØÈùûÁ©∫Â≠óÁ¨¶‰∏≤")
                return ""
            
            # ÈôêÂà∂ÊñáÊú¨ÈïøÂ∫¶ÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ∫¢Âá∫
            global max_length
            if len(markdown_text) > max_length:
                print(f"‚ö†Ô∏è ÊñáÊú¨ËøáÈïøÔºà{len(markdown_text)} Â≠óÁ¨¶ÔºâÔºåÊà™Êñ≠Âà∞ {max_length} Â≠óÁ¨¶")
                markdown_text = markdown_text[:max_length]
            
            # ‰ΩøÁî®‰∏¥Êó∂ÁõÆÂΩïÈÅøÂÖçÊñá‰ª∂ÂÜ≤Á™Å
            with tempfile.TemporaryDirectory() as temp_dir:
                self.hti.output_path = temp_dir
                
                # ÈÖçÁΩÆÊâ©Â±ï
                extensions, extension_configs = self._get_extensions_and_config()
                
                # ËΩ¨Êç¢ Markdown Âà∞ HTML
                html_content = markdown.markdown(
                    markdown_text, 
                    extensions=extensions,
                    extension_configs=extension_configs
                )
                
                # Âä®ÊÄÅËÆ°ÁÆóÊâÄÈúÄÈ´òÂ∫¶
                estimated_height = self.estimate_height(markdown_text)
                
                # ÂÆåÊï¥ÁöÑ CSS Ê†∑Âºè
                styled_html = self._create_styled_html(html_content)
                
                # ‰ΩøÁî®Âä®ÊÄÅËÆ°ÁÆóÁöÑÈ´òÂ∫¶ËøõË°åÊà™Âõæ
                filename = "temp.png"
                self.hti.screenshot(
                    html_str=styled_html, 
                    save_as=filename,
                    #side_of_markdownÈªòËÆ§800
                    size=(side_of_markdown, estimated_height)
                )
                
                # Ëé∑ÂèñÊñá‰ª∂Ë∑ØÂæÑ
                temp_path = os.path.join(temp_dir, filename)
                if not os.path.exists(temp_path):
                    temp_path = filename
                
                # È™åËØÅÊñá‰ª∂ÊòØÂê¶Â≠òÂú®‰∏îÊúâÊïà
                if not os.path.exists(temp_path):
                    print("‚ùå ÁîüÊàêÁöÑÂõæÁâáÊñá‰ª∂‰∏çÂ≠òÂú®")
                    return ""
                
                file_size = os.path.getsize(temp_path)
                if file_size == 0:
                    print("‚ùå ÁîüÊàêÁöÑÂõæÁâáÊñá‰ª∂‰∏∫Á©∫")
                    return ""
                
                if file_size > 15 * 1024 * 1024:  # 10MB ÈôêÂà∂
                    print(f"‚ùå ÁîüÊàêÁöÑÂõæÁâáËøáÂ§ßÔºà{file_size / 1024 / 1024:.2f}MBÔºâ")
                    return ""
                
                # ËØªÂèñÂõæÁâáÂπ∂ËΩ¨Êç¢‰∏∫Á∫Ø Base64
                with open(temp_path, 'rb') as f:
                    image_data = f.read()
                
                # ËΩ¨Êç¢‰∏∫Á∫Ø Base64
                pure_base64 = base64.b64encode(image_data).decode('utf-8')
                
                print(f"‚úÖ ÂõæÁâáÁîüÊàêÊàêÂäüÔºö{file_size / 1024:.2f}KBÔºåBase64 ÈïøÂ∫¶Ôºö{len(pure_base64)}")
                return pure_base64
                
        except Exception as e:
            print(f"ÂêåÊ≠•ËΩ¨Êç¢ÈîôËØØ: {e}")
            import traceback
            traceback.print_exc()
            return ""
    
    async def convert_async(self, markdown_text: str, timeout: int = 30) -> str:
        """ÂºÇÊ≠•ËΩ¨Êç¢ÊñπÊ≥ï
        
        Args:
            markdown_text: Markdown ÊñáÊú¨ÂÜÖÂÆπ
            timeout: Ë∂ÖÊó∂Êó∂Èó¥ÔºàÁßíÔºâÔºåÈªòËÆ§30Áßí
            
        Returns:
            Base64 ÁºñÁ†ÅÁöÑÂõæÁâáÂ≠óÁ¨¶‰∏≤
        """
        loop = asyncio.get_event_loop()
        try:
            result = await loop.run_in_executor(
                self.executor,
                self.convert,
                markdown_text,
                timeout
            )
            return result
        except Exception as e:
            print(f"ÂºÇÊ≠•ËΩ¨Êç¢ÈîôËØØ: {e}")
            return ""
    
    def cleanup(self):
        """Ê∏ÖÁêÜËµÑÊ∫ê"""
        if self.executor:
            self.executor.shutdown(wait=False)
        self._initialized = False
        self.hti = None
    
    def _get_extensions_and_config(self):
        """Ëé∑ÂèñÊâ©Â±ïÂíåÈÖçÁΩÆ"""
        if PYMDEXT_AVAILABLE:
            # ‰ΩøÁî® pymdown-extensions ÁöÑÂÆåÊï¥ÈÖçÁΩÆ
            extensions = [
                'pymdownx.extra',
                'pymdownx.superfences',
                'pymdownx.highlight',
                'pymdownx.inlinehilite',
                'pymdownx.tabbed',
                'pymdownx.tasklist',
                'pymdownx.tilde',
                'pymdownx.caret',
                'pymdownx.mark',
                'pymdownx.smartsymbols',
                'pymdownx.betterem',
                'pymdownx.details',
                'pymdownx.emoji',
                'pymdownx.keys',
                'pymdownx.progressbar',
                'pymdownx.saneheaders',
                #'toc',
                'tables',
                'nl2br',
                'sane_lists',
                'attr_list',
                'md_in_html'
            ]
            
            extension_configs = {
                'pymdownx.highlight': {
                    'use_pygments': True,
                    'css_class': 'highlight',
                    'linenums': False
                },
                'pymdownx.superfences': {
                    'custom_fences': [
                        {
                            'name': 'mermaid',
                            'class': 'mermaid',
                            'format': pymdownx.superfences.fence_div_format
                        }
                    ]
                },
                'pymdownx.emoji': {
                    'emoji_index': pymdownx.emoji.twemoji,
                    'emoji_generator': pymdownx.emoji.to_svg
                },
                'pymdownx.tasklist': {
                    'custom_checkbox': True
                },
                'toc': {
                    'permalink': True
                }
            }
        else:
            # Â§áÁî®ÈÖçÁΩÆ
            extensions = [
                'extra', 'sane_lists', 'nl2br', 
                'fenced_code', 'tables', 'attr_list', 'md_in_html'
            ]
            extension_configs = {}
            
        return extensions, extension_configs
    
    def _create_styled_html(self, html_content: str) -> str:
        """ÂàõÂª∫Â∏¶ÂÆåÊï¥Ê†∑ÂºèÁöÑ HTML"""
        return f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {{
                    font-family: "WenQuanYi Micro Hei", "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    padding: 20px;
                    background: white;
                    max-width: 800px;
                    margin: 0 auto;
                    word-wrap: break-word;
                }}
                h1, h2, h3, h4, h5, h6 {{
                    color: #2c3e50;
                    margin: 1.2em 0 0.6em 0;
                    line-height: 1.3;
                }}
                h1 {{ 
                    font-size: 1.8em; 
                    border-bottom: 2px solid #3498db; 
                    padding-bottom: 0.3em; 
                }}
                h2 {{ 
                    font-size: 1.5em; 
                    border-bottom: 1px solid #bdc3c7; 
                    padding-bottom: 0.2em; 
                }}
                h3 {{ font-size: 1.3em; }}
                h4 {{ font-size: 1.2em; }}
                h5 {{ font-size: 1.1em; }}
                h6 {{ font-size: 1em; color: #7f8c8d; }}
                
                p {{ margin: 0.8em 0; }}
                
                a {{ color: #3498db; text-decoration: none; }}
                a:hover {{ text-decoration: underline; }}
                
                strong, b {{ font-weight: bold; color: #2c3e50; }}
                em, i {{ font-style: italic; }}
                
                /* pymdownx Êâ©Â±ïÊ†∑Âºè */
                .highlight {{
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    overflow: auto;
                    line-height: 1.4;
                    border: 1px solid #e9ecef;
                    margin: 1em 0;
                }}
                
                code {{
                    background: #f8f9fa;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                    font-size: 0.9em;
                    border: 1px solid #e9ecef;
                }}
                
                pre {{
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    overflow: auto;
                    line-height: 1.4;
                    border: 1px solid #e9ecef;
                    margin: 1em 0;
                }}
                
                pre code {{
                    background: none;
                    padding: 0;
                    border: none;
                }}
                
                blockquote {{
                    border-left: 4px solid #3498db;
                    padding-left: 15px;
                    margin: 1em 0;
                    color: #7f8c8d;
                    background: #f8f9fa;
                    padding: 10px 15px;
                    border-radius: 0 5px 5px 0;
                }}
                
                ul, ol {{
                    padding-left: 2em;
                    margin: 1em 0;
                }}
                
                li {{
                    margin: 0.3em 0;
                }}
                
                /* ‰ªªÂä°ÂàóË°®Ê†∑Âºè - Â¢ûÂº∫ÁâàÊú¨ */
                .task-list-item {{
                    list-style-type: none;
                    margin-left: -1.5em;
                }}
                .task-list-item input[type="checkbox"] {{
                    margin-right: 0.5em;
                    transform: scale(1.2);
                }}
                .task-list-item input[type="checkbox"]:checked + * {{
                    text-decoration: line-through;
                    color: #95a5a6;
                }}
                
                /* Ë°®Ê†ºÊ†∑Âºè */
                table {{
                    border-collapse: collapse;
                    width: 100%;
                    margin: 1em 0;
                }}
                
                th, td {{
                    border: 1px solid #ddd;
                    padding: 8px 12px;
                    text-align: left;
                }}
                
                th {{
                    background-color: #3498db;
                    color: white;
                    font-weight: bold;
                }}
                
                tr:nth-child(even) {{
                    background-color: #f8f9fa;
                }}
                
                /* Ê∞¥Âπ≥Á∫øÊ†∑Âºè */
                hr {{
                    border: none;
                    height: 2px;
                    background: linear-gradient(90deg, transparent, #3498db, transparent);
                    margin: 2em 0;
                }}
                
                /* ÂõæÁâáÊ†∑Âºè */
                img {{
                    max-width: 100%;
                    height: auto;
                    display: block;
                    margin: 1em auto;
                }}
                
                /* ‰ª£Á†ÅÈ´ò‰∫ÆÊ†∑Âºè */
                .highlight .hll {{ background-color: #ffffcc }}
                .highlight {{ background: #f8f9fa; }}
                .highlight .c {{ color: #999988; font-style: italic }} /* Comment */
                .highlight .err {{ color: #a61717; background-color: #e3d2d2 }} /* Error */
                .highlight .k {{ color: #000000; font-weight: bold }} /* Keyword */
                .highlight .o {{ color: #000000; font-weight: bold }} /* Operator */
                .highlight .cm {{ color: #999988; font-style: italic }} /* Comment.Multiline */
                .highlight .cp {{ color: #999999; font-weight: bold; font-style: italic }} /* Comment.Preproc */
                .highlight .c1 {{ color: #999988; font-style: italic }} /* Comment.Single */
                .highlight .cs {{ color: #999999; font-weight: bold; font-style: italic }} /* Comment.Special */
                .highlight .gd {{ color: #000000; background-color: #ffdddd }} /* Generic.Deleted */
                .highlight .ge {{ color: #000000; font-style: italic }} /* Generic.Emph */
                .highlight .gr {{ color: #aa0000 }} /* Generic.Error */
                .highlight .gh {{ color: #999999 }} /* Generic.Heading */
                .highlight .gi {{ color: #000000; background-color: #ddffdd }} /* Generic.Inserted */
                .highlight .go {{ color: #888888 }} /* Generic.Output */
                .highlight .gp {{ color: #555555 }} /* Generic.Prompt */
                .highlight .gs {{ font-weight: bold }} /* Generic.Strong */
                .highlight .gu {{ color: #aaaaaa }} /* Generic.Subheading */
                .highlight .gt {{ color: #aa0000 }} /* Generic.Traceback */
                .highlight .kc {{ color: #000000; font-weight: bold }} /* Keyword.Constant */
                .highlight .kd {{ color: #000000; font-weight: bold }} /* Keyword.Declaration */
                .highlight .kn {{ color: #000000; font-weight: bold }} /* Keyword.Namespace */
                .highlight .kp {{ color: #000000; font-weight: bold }} /* Keyword.Pseudo */
                .highlight .kr {{ color: #000000; font-weight: bold }} /* Keyword.Reserved */
                .highlight .kt {{ color: #445588; font-weight: bold }} /* Keyword.Type */
                .highlight .m {{ color: #009999 }} /* Literal.Number */
                .highlight .s {{ color: #d01040 }} /* Literal.String */
                .highlight .na {{ color: #008080 }} /* Name.Attribute */
                .highlight .nb {{ color: #0086B3 }} /* Name.Builtin */
                .highlight .nc {{ color: #445588; font-weight: bold }} /* Name.Class */
                .highlight .no {{ color: #008080 }} /* Name.Constant */
                .highlight .nd {{ color: #3c5d5d; font-weight: bold }} /* Name.Decorator */
                .highlight .ni {{ color: #800080 }} /* Name.Entity */
                .highlight .ne {{ color: #990000; font-weight: bold }} /* Name.Exception */
                .highlight .nf {{ color: #990000; font-weight: bold }} /* Name.Function */
                .highlight .nl {{ color: #990000; font-weight: bold }} /* Name.Label */
                .highlight .nn {{ color: #555555 }} /* Name.Namespace */
                .highlight .nt {{ color: #000080 }} /* Name.Tag */
                .highlight .nv {{ color: #008080 }} /* Name.Variable */
                .highlight .ow {{ color: #000000; font-weight: bold }} /* Operator.Word */
                .highlight .w {{ color: #bbbbbb }} /* Text.Whitespace */
                .highlight .mf {{ color: #009999 }} /* Literal.Number.Float */
                .highlight .mh {{ color: #009999 }} /* Literal.Number.Hex */
                .highlight .mi {{ color: #009999 }} /* Literal.Number.Integer */
                .highlight .mo {{ color: #009999 }} /* Literal.Number.Oct */
                .highlight .sb {{ color: #d01040 }} /* Literal.String.Backtick */
                .highlight .sc {{ color: #d01040 }} /* Literal.String.Char */
                .highlight .sd {{ color: #d01040 }} /* Literal.String.Doc */
                .highlight .s2 {{ color: #d01040 }} /* Literal.String.Double */
                .highlight .se {{ color: #d01040 }} /* Literal.String.Escape */
                .highlight .sh {{ color: #d01040 }} /* Literal.String.Heredoc */
                .highlight .si {{ color: #d01040 }} /* Literal.String.Interpol */
                .highlight .sx {{ color: #d01040 }} /* Literal.String.Other */
                .highlight .sr {{ color: #009926 }} /* Literal.String.Regex */
                .highlight .s1 {{ color: #d01040 }} /* Literal.String.Single */
                .highlight .ss {{ color: #990073 }} /* Literal.String.Symbol */
                .highlight .bp {{ color: #999999 }} /* Name.Builtin.Pseudo */
                .highlight .vc {{ color: #008080 }} /* Name.Variable.Class */
                .highlight .vg {{ color: #008080 }} /* Name.Variable.Global */
                .highlight .vi {{ color: #008080 }} /* Name.Variable.Instance */
                .highlight .il {{ color: #009999 }} /* Literal.Number.Integer.Long */
                
                /* pymdownx ÁâπÊÆäÂÖÉÁ¥†Ê†∑Âºè */
                .tabbed-set {{ margin: 1em 0; }}
                .tabbed-content {{ padding: 1em; border: 1px solid #e9ecef; border-top: none; }}
                .tabbed-labels {{ background: #f8f9fa; padding: 0.5em; }}
                .tabbed-labels label {{ display: inline-block; padding: 0.5em 1em; cursor: pointer; }}
                .tabbed-labels label:hover {{ background: #e9ecef; }}
                
                .details {{ margin: 1em 0; border: 1px solid #e9ecef; border-radius: 5px; }}
                .details summary {{ padding: 1em; background: #f8f9fa; cursor: pointer; }}
                .details .details-content {{ padding: 1em; }}
                
                .keys {{ background: #f8f9fa; padding: 2px 6px; border-radius: 3px; border: 1px solid #e9ecef; }}
                
                .progress {{ background: #e9ecef; border-radius: 3px; height: 20px; margin: 0.5em 0; }}
                .progress-bar {{ background: #3498db; height: 100%; border-radius: 3px; }}
                
                mark {{ background: #fff3cd; padding: 2px 4px; }}
                
                .emoji {{ width: 1em; height: 1em; vertical-align: -0.1em; }}
            </style>
        </head>
        <body>
            {html_content}
        </body>
        </html>
        """
    
    def estimate_height(self, markdown_text: str) -> int:
        """Ê†πÊçÆÂÜÖÂÆπ‰º∞ÁÆóÊâÄÈúÄÈ´òÂ∫¶Ôºå‰ºòÂåñÁÆóÊ≥ï‰ª•ÊèêÈ´òÂáÜÁ°ÆÊÄß"""
        # Âü∫Á°ÄÈ´òÂ∫¶ÔºàÂåÖÂê´‰∏ä‰∏ãËæπË∑ùÔºâ
        base_height = 100
        
        # ËÆ°ÁÆóË°åÊï∞
        lines = markdown_text.split('\n')
        line_count = len(lines)
        
        # ÁªüËÆ°ÂêÑÁßçÂÖÉÁ¥†ÁöÑÊï∞Èáè
        code_block_lines = 0
        in_code_block = False
        header_count = 0
        table_rows = 0
        list_items = 0
        quote_lines = 0
        empty_lines = 0
        
        for line in lines:
            stripped = line.strip()
            
            # ÁªüËÆ°Á©∫Ë°å
            if not stripped:
                empty_lines += 1
                continue
            
            # ÁªüËÆ°‰ª£Á†ÅÂùó
            if stripped.startswith('```'):
                in_code_block = not in_code_block
                code_block_lines += 1
            elif in_code_block:
                code_block_lines += 1
            
            # ÁªüËÆ°Ê†áÈ¢ò
            elif re.match(r'^#{1,6}\s+', stripped):
                header_count += 1
            
            # ÁªüËÆ°Ë°®Ê†º
            elif '|' in stripped and not stripped.startswith('>'):
                table_rows += 1
            
            # ÁªüËÆ°ÂàóË°®
            elif re.match(r'^[\s]*[-*+]\s+', stripped) or re.match(r'^[\s]*\d+\.\s+', stripped):
                list_items += 1
            
            # ÁªüËÆ°ÂºïÁî®
            elif stripped.startswith('>'):
                quote_lines += 1
        
        # ËÆ°ÁÆóÊôÆÈÄöÊñáÊú¨Ë°åÊï∞ÔºàÈùû‰ª£Á†ÅÂùó„ÄÅÈùûÁ©∫Ë°åÔºâ
        normal_lines = line_count - code_block_lines - empty_lines
        
        # È´òÂ∫¶ËÆ°ÁÆóÔºàÂçï‰ΩçÔºöÂÉèÁ¥†Ôºâ
        # ÊôÆÈÄöÊñáÊú¨ÔºöÊØèË°åÁ∫¶28pxÔºàÂåÖÂê´Ë°åÈó¥Ë∑ùÔºâ
        # ‰ª£Á†ÅÂùóÔºöÊØèË°åÁ∫¶20pxÔºàÂ≠ó‰ΩìËæÉÂ∞èÔºåË°åÈó¥Ë∑ùÁ¥ßÂáëÔºâ
        # Ê†áÈ¢òÔºöÊØè‰∏™Á∫¶40-60pxÔºàÊ†πÊçÆÁ∫ßÂà´Ôºâ
        # Ë°®Ê†ºÔºöÊØèË°åÁ∫¶30px
        # ÂàóË°®È°πÔºöÊØè‰∏™Á∫¶25px
        # ÂºïÁî®ÔºöÊØèË°åÁ∫¶25px
        # Á©∫Ë°åÔºöÊØè‰∏™Á∫¶15px
        
        estimated_height = (
            base_height +
            (normal_lines * 28) +
            (code_block_lines * 20) +
            (header_count * 50) +
            (table_rows * 30) +
            (list_items * 25) +
            (quote_lines * 25) +
            (empty_lines * 15)
        )
        
        # Ê†πÊçÆÁâπÊÆäÂÖÉÁ¥†Â¢ûÂä†È¢ùÂ§ñÈ´òÂ∫¶
        if table_rows > 0:
            estimated_height += 50  # Ë°®Ê†ºËæπÊ°ÜÂíåÈó¥Ë∑ù
        
        if code_block_lines > 0:
            estimated_height += 30  # ‰ª£Á†ÅÂùóËæπÊ°ÜÂíåÂÜÖËæπË∑ù
        
        # Á°Æ‰øùÊúÄÂ∞èÂíåÊúÄÂ§ßÈ´òÂ∫¶
        min_height = 300
        max_height = 10000  # ÊèêÈ´òÂà∞10000px‰ª•ÊîØÊåÅÈïøÊñáÊ°£
        
        estimated_height = max(min_height, min(estimated_height, max_height))
        
        print(f"üìè È´òÂ∫¶‰º∞ÁÆóÔºö{estimated_height}pxÔºàË°åÊï∞Ôºö{line_count}Ôºå‰ª£Á†ÅÔºö{code_block_lines}ÔºåÊ†áÈ¢òÔºö{header_count}ÔºåË°®Ê†ºÔºö{table_rows}Ôºâ")
        
        return estimated_height
        
        print(f"‰º∞ÁÆóÈ´òÂ∫¶: {estimated_height}px (Ë°åÊï∞: {line_count}, ‰ª£Á†ÅË°å: {code_block_lines})")
        
        return estimated_height

class DefaultEventListener(
    EventListener,
):
    def __init__(self):
        super().__init__()
        self.converter = None
        self.max_retries = 2
        
    async def initialize(self):
        await super().initialize()
        
        @self.handler(events.NormalMessageResponded)
        async def handler(event_context):
            config()
            global response_text 
            global get_markdown
            global out_photo
            markdown_number = get_markdown
            response_text = event_context.event.response_text
            
            if test_mode:
                print(response_text)
            print('\n')
            print("-" * 50)
            
            # ÈÄêË°åÂàÜÊûêMarkdownÊ†ºÂºè
            lines = response_text.split('\n')
            #ËÆ∞ÂΩïurl
            url = ""
            have_url = False
            for i, line in enumerate(lines, 1):
                is_markdown, features, Url = self.analyze_line_markdown(line.strip())
                status = "‚úì Markdown" if is_markdown else "‚úó ÊôÆÈÄöÊñáÊú¨"
                if Url:
                    url += line.strip() + "\n"
                    have_url = True
                
                if is_markdown:
                    markdown_number -= 1
                
                features_str = f" [{', '.join(features)}]" if features else ""
                print(f"Á¨¨{i}Ë°å: {status}{features_str} -> {repr(line)}")

            if markdown_number <= 0:
                # Âª∂ËøüÂàùÂßãÂåñËΩ¨Êç¢Âô®
                if self.converter is None:
                    self.converter = MarkdownToBase64Converter()
                
                # ‰ΩøÁî®ÂºÇÊ≠•ËΩ¨Êç¢ÊñπÊ≥ïÔºåÂ∏¶ÈáçËØïÊú∫Âà∂
                base64_image = await self._convert_with_retry(response_text)

                if base64_image:
                    print(f"‚úÖ ËΩ¨Êç¢ÊàêÂäüÔºÅBase64 ÈïøÂ∫¶: {len(base64_image)}")
                    if test_mode:
                        print(base64_image[:100] + "..." if len(base64_image) > 100 else base64_image)
                    
                    try:
                        if have_url:
                            await event_context.reply(
                                platform_message.MessageChain([
                                    platform_message.Image(base64=base64_image),
                                    platform_message.Plain(text=url)
                                ])
                            )
                        else:
                            await event_context.reply(
                                platform_message.MessageChain([
                                    platform_message.Image(base64=base64_image)
                                ])
                            )
                        
                        if breakout:
                            event_context.prevent_default()
                    except Exception as e:
                        print(f"‚ùå ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•: {e}")
                        import traceback
                        traceback.print_exc()
                else:
                    print(f"‚ùå ËΩ¨Êç¢Â§±Ë¥•ÔºåË∑≥ËøáÂõæÁâáÂèëÈÄÅ")
    
    async def _convert_with_retry(self, markdown_text: str, timeout: int = 30) -> str:
        """Â∏¶ÈáçËØïÊú∫Âà∂ÁöÑËΩ¨Êç¢ÊñπÊ≥ï
        
        Args:
            markdown_text: Markdown ÊñáÊú¨ÂÜÖÂÆπ
            timeout: ÊØèÊ¨°Â∞ùËØïÁöÑË∂ÖÊó∂Êó∂Èó¥ÔºàÁßíÔºâ
            
        Returns:
            Base64 ÁºñÁ†ÅÁöÑÂõæÁâáÂ≠óÁ¨¶‰∏≤ÔºåÂ§±Ë¥•ËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
        """
        for attempt in range(self.max_retries + 1):
            try:
                print(f"üîÑ ËΩ¨Êç¢Â∞ùËØï {attempt + 1}/{self.max_retries + 1}")
                
                # ‰ΩøÁî®ÂºÇÊ≠•ËΩ¨Êç¢
                result = await self.converter.convert_async(markdown_text, timeout)
                
                if result:
                    print(f"‚úÖ ËΩ¨Êç¢ÊàêÂäüÔºàÂ∞ùËØï {attempt + 1}Ôºâ")
                    return result
                else:
                    print(f"‚ö†Ô∏è ËΩ¨Êç¢ËøîÂõûÁ©∫ÁªìÊûúÔºàÂ∞ùËØï {attempt + 1}Ôºâ")
                    
            except asyncio.TimeoutError:
                print(f"‚è±Ô∏è ËΩ¨Êç¢Ë∂ÖÊó∂ÔºàÂ∞ùËØï {attempt + 1}Ôºâ")
            except Exception as e:
                print(f"‚ùå ËΩ¨Êç¢ÂºÇÂ∏∏ÔºàÂ∞ùËØï {attempt + 1}Ôºâ: {e}")
                import traceback
                traceback.print_exc()
            
            # Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÊ¨°Â∞ùËØïÔºåÁ≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂÜçÈáçËØï
            if attempt < self.max_retries:
                wait_time = (attempt + 1) * 2  # ÊåáÊï∞ÈÄÄÈÅøÔºö2Áßí„ÄÅ4Áßí
                print(f"‚è≥ Á≠âÂæÖ {wait_time} ÁßíÂêéÈáçËØï...")
                await asyncio.sleep(wait_time)
        
        print(f"‚ùå ÊâÄÊúâËΩ¨Êç¢Â∞ùËØïÂùáÂ§±Ë¥•")
        return ""
    
    def cleanup(self):
        """Ê∏ÖÁêÜËµÑÊ∫ê"""
        if self.converter:
            self.converter.cleanup()
            self.converter = None
                        
    def analyze_line_markdown(self, line: str) -> tuple[bool, list[str]]:
        """ÂàÜÊûêÂçïË°åÊòØÂê¶‰∏∫MarkdownÊ†ºÂºè"""
        features = []

        Url = False
        
        # Ê£ÄÊü•Ê†áÈ¢ò (#, ##, ###)
        if re.search(r'^#{1,6}\s+.+', line):
            features.append("Ê†áÈ¢ò")
            
        # Ê£ÄÊü•Á≤ó‰Ωì (** Êàñ __)
        if re.search(r'\*\*.+?\*\*', line) or re.search(r'__.+?__', line):
            features.append("Á≤ó‰Ωì")
            
        # Ê£ÄÊü•Êñú‰Ωì (* Êàñ _)
        if re.search(r'\*[^*\n].*?\*', line) or re.search(r'_[^_\n].*?_', line):
            features.append("Êñú‰Ωì")
            
        # Ê£ÄÊü•Ë°åÂÜÖ‰ª£Á†Å (`)
        if re.search(r'`[^`\n]+?`', line):
            features.append("Ë°åÂÜÖ‰ª£Á†Å")
            
        # Ê£ÄÊü•ÂàóË°® (-, *, + Êàñ Êï∞Â≠ó.)
        if re.search(r'^[\s]*[-*+]\s+.+', line) or re.search(r'^[\s]*\d+\.\s+.+', line):
            features.append("ÂàóË°®")
            
        # Ê£ÄÊü•ÂºïÁî® (>)
        if re.search(r'^>+\s+.+', line):
            features.append("ÂºïÁî®Âùó")
            
        # Ê£ÄÊü•ÈìæÊé• ([ÊñáÂ≠ó](ÈìæÊé•))
        if re.search(r'\[.*?\]\(.*?\)', line):
            features.append("ÈìæÊé•")
            if re.search(r'http', line):
                Url = True
             
        # Ê£ÄÊü•ÂõæÁâá (![alt](src))
        if re.search(r'!\[.*?\]\(.*?\)', line):
            features.append("ÂõæÁâá")
            if out_photo:
                if re.search(r'http', line):
                    Url = True
            
        # Ê£ÄÊü•ÂàÜÂâ≤Á∫ø (---, ***)
        if re.search(r'^---+\s*$', line) or re.search(r'^\*\*\*+\s*$', line):
            features.append("ÂàÜÂâ≤Á∫ø")

        # Ê£ÄÊü•‰ª£Á†ÅÂùóÂºÄÂßãÊàñÁªìÊùü
        if line.strip() == '```' or line.startswith('```'):
            features.append("‰ª£Á†ÅÂùóÊ†áËÆ∞")

        # Â¶ÇÊûúÊúâ‰ªªÊÑèMarkdownÁâπÊÄßÔºåÂ∞±ËÆ§‰∏∫ÊòØMarkdownÊ†ºÂºè
        is_markdown = len(features) > 0
        
        return is_markdown, features, Url
